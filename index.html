<!DOCTYPE html>
<title>Astroids!</title>
<body><script>

    document.body.style.backgroundColor = 'black'
    document.body.style.margin = '0px'
    document.body.style.overflow = 'hidden'
    
    let implodeSound = new Audio('sounds/oof.mp3')
    
    let keyboard = {}
    addEventListener('keydown', function(event) {keyboard[event.key] = true})
    addEventListener('keyup', function(event) {keyboard[event.key] = false})
    
    let ship = createShip()

    let astroids = [
        createAstroid(),
        createAstroid(),
        createAstroid(),
        createAstroid(),
        createAstroid(),
    ]

    let bullets = []

    runGame()

    function now() {
        return performance.now() / 1000
    }

    function createShip() {
        let x = window.innerWidth / 2
        let y = window.innerHeight / 2
        let ship = createSprite('sprites/ship.png', 100, 100, x, y, 0)
        return ship
    }

    function createAstroid() {
        let x = window.innerWidth * Math.random()
        let y = window.innerHeight * Math.random()
        let astroid = createSprite('sprites/rock.png', 300, 300, x, y, 0)
        astroid.velocityX = Math.cos(Math.random() * 2 * Math.PI) * 3
        astroid.velocityY = Math.sin(Math.random() * 2 * Math.PI) * 3
        return astroid
    }

    function createBullet() {
        let x = ship.x
        let y = ship.y
        let bullet = createSprite('sprites/bullet.png', 4, 4, x, y, 0)
        bullet.velocityX = ship.velocityX + Math.cos(ship.radians) * 13
        bullet.velocityY = ship.velocityY + Math.sin(ship.radians) * 13
        bullet.lifeEnd = now() + 1
        return bullet
    }

    function createSprite(image, width, height, x, y, radians) {
        return {
            element: createSpriteElement(image, width, height, x, y, radians),
            x: x,
            y: y,
            velocityX: 0,
            velocityY: 0,
            radians: radians,
        }
    }
    
    function createSpriteElement(image, width, height, x, y, radians) {
        let element = document.createElement('div')
        element.style.position = 'absolute'
        element.style.width = width + 'px'
        element.style.height = height + 'px'
        element.style.transform = 'translate(-50%, -50%)'
        element.style.transformOrigin = 'top left'
        element.style.backgroundImage = 'url("' + image + '")'
        element.style.backgroundSize = 'contain' 
        element.style.backgroundRepeat = "no-repeat";
        element.style.imageRendering = "pixelated";
        element.style.left = x + 'px'
        element.style.top = y + 'px'
        element.style.rotate = radians + 'rad'
        document.body.appendChild(element)
        return element
    }

    function runGame() {
        controlShip()
        moveSprite(ship)
        for(let astroid of astroids) moveSprite(astroid)
        bullets = bullets.filter(function(bullet) {
            let remove = bullet.lifeEnd < now()
            if(remove) bullet.element.remove()
            return !remove
        })
        for(let bullet of bullets) moveSprite(bullet) 
        collide()
        requestAnimationFrame(runGame)
    }    

    function controlShip() {
        if(keyboard.ArrowLeft) {
            ship.radians -= 0.1
        }
        if(keyboard.ArrowRight) {
            ship.radians += 0.1
        }
        if(keyboard.ArrowUp) {
            ship.velocityX += Math.cos(ship.radians) * 0.1
            ship.velocityY += Math.sin(ship.radians) * 0.1
        }
        if(keyboard.Enter) {
            let bullet = createBullet()  
            bullets.push(bullet)
        }
    }    

    function moveSprite(sprite) {
        sprite.x += sprite.velocityX
        sprite.y += sprite.velocityY
        let minX = -100
        let maxX = window.innerWidth + 100
        let minY = -100
        let maxY = window.innerHeight + 100
        if(sprite.x < minX) sprite.x = maxX
        if(sprite.x > maxX) sprite.x = minX
        if(sprite.y < minY) sprite.y = maxY
        if(sprite.y > maxY) sprite.y = minY
        sprite.element.style.left = sprite.x + 'px'
        sprite.element.style.top = sprite.y + 'px'
        sprite.element.style.rotate = sprite.radians + 'rad'
    }

    function collide() {
        for(let astroid of astroids) {
            let dx = astroid.x - ship.x
            let dy = astroid.y - ship.y
            let distance = Math.sqrt(dx*dx + dy*dy)
            if(distance < 130) {
                implodeSound.play()
            }

            for(let bullet of bullets) {
                let dx2 = bullet.x - astroid.x
                let dy2 = bullet.y - astroid.y
                let distance2 = Math.sqrt(dx2*dx2 + dy2*dy2)
                if (distance2 < 150) {
                    // TODO remove the astroid from the astroids array as well
                    // TODO play sound
                    astroid.element.remove()
                }
            }
        }
    }

</script></body>
